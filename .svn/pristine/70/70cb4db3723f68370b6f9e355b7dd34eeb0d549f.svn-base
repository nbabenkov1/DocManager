package utils.pdf;

import models.Document;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import repository.DocumentRepository;

import java.io.File;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Writes objects from {@link DocumentRepository} into pdf file(s)
 **/
@Component
public class DocumentToPDFManager {
    @Value("${Rep.Dir.Homedir}")
    private String homeDir;

    private final int[] districts = {11, 13, 14, 15, 16};

    /**
     * Writes {@link DocumentRepository#documentList} into pdf
     *
     * @return {@link PDDocument}
     */
    public PDDocument writeListToPDF(PDFConfig pdfConfig, List<DocumentRepository> documentRepositories) throws IOException {
        PDFWriter pdfWriter = new PDFWriter(pdfConfig);

        for (DocumentRepository documentRepository : documentRepositories) {
            List<Document> documentList = documentRepository.getDocumentList();
            for (int i = 0; i < documentList.size(); i++) {
                if (writeDocumentToPDF(pdfWriter, documentList.get(i))) {
                    documentList.remove(i);
                    i--;
                }
            }
        }
        return pdfWriter.getPdDocument();
    }

    /**
     * Writes {@link Document#docPage} from {@link Document} into pdf via {@link PDFWriter}
     */
    private boolean writeDocumentToPDF(PDFWriter pdfWriter, Document document) throws IOException {
        if (document.getDocPage() != null) {
            pdfWriter.writePageToPDF(document.getDocPage());
            return true;
        }
        return false;
    }

    /**
     * Creates and saves pdf files for each district from
     * {@link DocumentRepository#documentList}
     */
    public void saveToPDFFiles(DocumentRepository repository, PDFConfig pdfConfig) throws IOException {
        prepareDirectories();
        repository.sortCollection();
        List<Document> documentList = repository.getDocumentList();
        Map<Integer, PDFWriter> pdfWriters = new HashMap<>();

        for (int i = 0; i <= 4; i++) {
            pdfWriters.put(districts[i], new PDFWriter(pdfConfig));
        }

        for (Document document : documentList) {
            if (document.getDocPage() == null) continue;
            pdfWriters.get(document.getRes()).writePageToPDF(document.getDocPage());
        }

        for (int i = 0; i <= 4; i++) {
            File file = new File(homeDir
                    + "ActsFiles" + File.separator + "RS" + districts[i] + ".pdf");
            try (PDDocument pdDocument = pdfWriters.get(districts[i]).getPdDocument()) {
                pdDocument.save(file);
                file.createNewFile();
            }
        }
    }

    /**
     * Clears/creates ActsFiles folder on server
     */
    private void prepareDirectories() throws IOException {
        File directory = new File(homeDir + "ActsFiles");
        if (!directory.exists()) {
            if (!directory.mkdirs())
                throw new IOException("Couldn't create directory for pdf");
        } else {
            File[] files = directory.listFiles();
            if (files == null)
                return;
            for (File f : files) {
                if (f.getAbsolutePath().endsWith(".pdf"))
                    if (!f.delete())
                        throw new IOException("Couldn't delete pdf file");
            }
        }
    }
}
