package utils.fileUploading;

import org.apache.poi.util.IOUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.web.multipart.MultipartFile;

import java.io.*;
import java.util.Calendar;

/**
 * Stores file in repository on server
 **/
@Component
public class DocumentUploader {
    @Value("${Rep.Dir.Homedir}")
    private String directoryPath;

    public DocumentUploader() {
    }

    public void saveFile(String docType, String period, String month, MultipartFile file) throws IOException {
        String fullPath = getFullPath(period, month);
        checkDirectory(fullPath);
        try (BufferedInputStream is = new BufferedInputStream(file.getInputStream())) {
            BufferedOutputStream os = new BufferedOutputStream(new FileOutputStream(prepareFile(docType, fullPath)));
            IOUtils.copy(is, os);
        }
    }

    private void checkDirectory(String fullPath) throws IOException {
        File filePath = new File(fullPath);
        filePath.mkdirs();
    }

    private File prepareFile(String docType, String fullPath) throws IOException {
        String fileFullName = fullPath + File.separator +
                Character.toUpperCase(docType.charAt(0)) +
                docType.substring(1, docType.length()) +
                ".txt";
        File file = new File(fileFullName);
        if (file.exists())
            file.delete();
        file.createNewFile();
        return file;
    }

    private String getFullPath(String period, String month) {
        return directoryPath + getYear(month) + File.separator +
                month + File.separator +
                period;
    }

    private String getYear(String month) {
        int currentMonth = Calendar.getInstance().get(Calendar.MONTH);
        int currentYear = Calendar.getInstance().get(Calendar.YEAR);
        if (month.equals("01") && currentMonth == 11)
            return String.valueOf(currentYear + 1);
        else if (month.equals("12") && currentMonth == 0)
            return String.valueOf(currentYear - 1);
        else return String.valueOf(currentYear);
    }
}
